name: 1. Setup SukiSU (Files Only) & Push

on:
  workflow_dispatch:

jobs:
  setup_and_push:
    name: Download & Convert to Files
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      # 1. Checkout
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Jalankan Script SukiSU
      - name: Run SukiSU Curl Script
        run: |
          echo "Downloading SukiSU..."
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main

      # --- BAGIAN PENTING: UBAH SUBMODULE JADI FILE BIASA ---
      - name: Convert Submodule to Regular Files
        run: |
          echo "Removing .git directories inside KernelSU to force file tracking..."
          
          # Hapus folder .git di dalam drivers/kernelsu (jika ada)
          if [ -d "drivers/kernelsu/.git" ]; then
            rm -rf drivers/kernelsu/.git
            echo "Removed .git from drivers/kernelsu"
          fi

          # Hapus folder .git di dalam KernelSU (jika struktur beda)
          if [ -d "KernelSU/.git" ]; then
            rm -rf KernelSU/.git
            echo "Removed .git from KernelSU"
          fi
          
          # Hapus file .gitmodules jika ada (agar tidak dianggap submodule lagi)
          rm -f .gitmodules
          
          # Hapus cache git jika sebelumnya sudah dianggap submodule
          git rm --cached drivers/kernelsu || true
          git rm --cached KernelSU || true

      # 3. Commit dan Push
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Tambahkan semua file (sekarang akan dianggap file biasa)
          git add .
          
          # Cek status untuk memastikan file masuk
          git status
          
          git commit -m "chore: Add SukiSU Source Code (Editable) [skip ci]" || echo "No changes to commit"
          git push origin main
