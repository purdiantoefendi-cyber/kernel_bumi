name: Build Kernel by purdiantoefendi-cyber (Smart Build)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      # Langkah 1: Checkout Kode Sumber (DIPERBAIKI)
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1           # Diubah ke 1 agar lebih cepat & stabil
          persist-credentials: false # PENTING: Mencegah error "auth placeholder"
          submodules: true         # Mengambil submodule jika ada

      # Langkah 2: Install Dependensi
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc libssl-dev zip curl libstdc++6 git libncurses5-dev bison flex gcc-aarch64-linux-gnu

      # Langkah 3: Integrasi SukiSU-Ultra
      - name: Integrate SukiSU Ultra
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main

      # --- LANGKAH 4: DISABLE KPM & FIX CORE (PENTING) ---
      - name: Disable KPM & Fix Compatibility
        run: |
          echo "ðŸ”§ Starting configuration to DISABLE KPM..."

          # 1. Cari Makefile milik KernelSU/SukiSU
          # Kita cari file Makefile yang berada di dalam folder drivers/kernelsu (atau variannya)
          KSU_MAKEFILE=$(find drivers -path "*/kernelsu/Makefile" -type f | head -n 1)

          if [ -z "$KSU_MAKEFILE" ]; then
            echo "âŒ ERROR: Could not find KernelSU Makefile!"
            # Kita coba cari lebih luas jika path drivers salah
            KSU_MAKEFILE=$(find . -name "Makefile" | xargs grep -l "kernelsu" | head -n 1)
          fi

          if [ -n "$KSU_MAKEFILE" ]; then
            echo "âœ… Found Makefile at: $KSU_MAKEFILE"
            
            # --- ACTION: DISABLE KPM ---
            # Cari baris yang mencoba compile folder 'kpm' dan matikan dengan komentar (#)
            # Biasanya tertulis: obj-y += kpm/
            echo "   - Disabling KPM compilation in Makefile..."
            sed -i '/kpm\//s/^/#/' "$KSU_MAKEFILE"
            sed -i '/CONFIG_KSU_KPM/s/^/#/' "$KSU_MAKEFILE"
          else
             echo "âš ï¸ Warning: Makefile not found, skipping KPM disable (might fail later)."
          fi

          # 2. Fix Core KernelSU (ksu.c) - Masalah MODULE_IMPORT_NS (Gambar 4)
          # Ini WAJIB dilakukan meskipun KPM mati, karena ksu.c adalah intinya.
          KSU_C_FILE=$(find . -name "ksu.c" -type f | head -n 1)
          
          if [ -z "$KSU_C_FILE" ]; then
             echo "âš ï¸ Warning: ksu.c not found."
          else
             echo "âœ… Found ksu.c at: $KSU_C_FILE"
             echo "   - Removing MODULE_IMPORT_NS (New Kernel Feature)..."
             sed -i '/MODULE_IMPORT_NS/d' "$KSU_C_FILE"
             
             echo "   - Removing VFS_internal references..."
             sed -i '/VFS_internal/d' "$KSU_C_FILE"
          fi
          
          echo "âœ… Configuration complete. KPM is disabled

      # Langkah 5: Unduh Toolchain Clang
      - name: Download Clang Toolchain
        run: git clone https://gitlab.com/PixelOS-Devices/playgroundtc.git --depth=1 clang-toolchain

      # Langkah 6: Atur Environment Build
      - name: Set Up Build Environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=DianTk_Modz_sukiSU" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=GitHub-Actions" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "${{ github.workspace }}/clang-toolchain/bin" >> $GITHUB_PATH

      # Langkah 7: Buat .config
      - name: Generate .config
        run: make O=out earth_defconfig

      # Langkah 8: Kompilasi Kernel
      - name: Compile Kernel
        run: |
          # Menggunakan LLVM=1 dan mematikan error warning agar tidak stop
          make O=out -j$(nproc) KCFLAGS="-Wno-error" LLVM=1 || make O=out -j1 KCFLAGS="-Wno-error" LLVM=1

      # Langkah 9: Upload
      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            out/arch/arm64/boot/Image.gz*
            out/arch/arm64/boot/dts/**/*.dtb
