name: Build Kernel by purdiantoefendi-cyber (Smart Build)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      # Langkah 1: Checkout Kode Sumber (DIPERBAIKI)
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1           # Diubah ke 1 agar lebih cepat & stabil
          persist-credentials: false # PENTING: Mencegah error "auth placeholder"
          submodules: true         # Mengambil submodule jika ada

      # Langkah 2: Install Dependensi
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc libssl-dev zip curl libstdc++6 git libncurses5-dev bison flex gcc-aarch64-linux-gnu

      # Langkah 3: Integrasi SukiSU-Ultra
      - name: Integrate SukiSU Ultra
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main

      # --- PERBAIKAN TOTAL: PATCH COMPATIBILITY ---
      - name: Fix KernelSU for Old Kernels
        run: |
          echo "ðŸ” Searching for kpm.c and ksu.c..."
          
          # Cari lokasi file kpm.c secara otomatis (mengantisipasi beda folder)
          KPM_FILE=$(find . -name "kpm.c" -type f | head -n 1)
          KSU_FILE=$(find . -name "ksu.c" -type f | head -n 1)

          if [ -z "$KPM_FILE" ]; then
            echo "âŒ ERROR: Could not find kpm.c!"
            exit 1
          else
            echo "âœ… Found kpm.c at: $KPM_FILE"
            
            # 1. FIX access_ok (Menambah argumen 0)
            # Kita lakukan replace berulang untuk memastikan semua kena
            echo "   - Patching access_ok..."
            sed -i 's/access_ok(/access_ok(0, /g' "$KPM_FILE"
            sed -i 's/access_ok (/access_ok(0, /g' "$KPM_FILE"
          fi

          if [ -z "$KSU_FILE" ]; then
             echo "âš ï¸ Warning: ksu.c not found (skipped)."
          else
             echo "âœ… Found ksu.c at: $KSU_FILE"
             
             # 2. FIX MODULE_IMPORT_NS (Hapus fitur kernel baru)
             echo "   - Removing MODULE_IMPORT_NS..."
             sed -i '/MODULE_IMPORT_NS/d' "$KSU_FILE"
             
             # 3. FIX error 'missing type specifier' di ksu.c (jika ada)
             # Kadang error ini muncul karena header VFS_internal tidak terdefinisi
             sed -i '/VFS_internal_I_am_really/d' "$KSU_FILE"
          fi
          
          echo "âœ… All patches applied."

      # Langkah 5: Unduh Toolchain Clang
      - name: Download Clang Toolchain
        run: git clone https://gitlab.com/PixelOS-Devices/playgroundtc.git --depth=1 clang-toolchain

      # Langkah 6: Atur Environment Build
      - name: Set Up Build Environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=DianTk_Modz_sukiSU" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=GitHub-Actions" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "${{ github.workspace }}/clang-toolchain/bin" >> $GITHUB_PATH

      # Langkah 7: Buat .config
      - name: Generate .config
        run: make O=out earth_defconfig

      # Langkah 8: Kompilasi Kernel
      - name: Compile Kernel
        run: |
          # Menggunakan LLVM=1 dan mematikan error warning agar tidak stop
          make O=out -j$(nproc) KCFLAGS="-Wno-error" LLVM=1

      # Langkah 9: Upload
      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            out/arch/arm64/boot/Image.gz*
            out/arch/arm64/boot/dts/**/*.dtb
