name: Build Kernel by purdiantoefendi-cyber (Smart Build)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel by ${{ github.actor }}
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      # Langkah 1: Checkout Kode Sumber
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          ref: main   # branch kamu
          fetch-depth: 0   # penting agar bisa ambil history penuh
          submodules: recursive  # ini supaya subproject commit (KernelSU-Next) ikut diambil

      # Langkah 2: Install Dependensi
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc libssl-dev zip curl libstdc++6 git libncurses5-dev bison flex gcc-aarch64-linux-gnu

      # Langkah 3: Integrasi SukiSU-Ultra
      - name: Integrate SukiSU Ultra
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main

       # --- PERBAIKAN: PATCH COMPATIBILITY (GABUNGAN) ---
      - name: Fix KernelSU Compatibility
        run: |
          echo "Starting KernelSU patches for older kernels..."
          
          # --- PATCH 1: Fix access_ok (Masalah argumen 2 vs 3) ---
          FILE_KPM="drivers/kernelsu/kpm/kpm.c"
          if [ -f "$FILE_KPM" ]; then
            echo "Patching access_ok in $FILE_KPM..."
            # Gunakan regex yang lebih kuat untuk menangani spasi
            sed -i -E 's/access_ok\s*\(/access_ok(0, /g' "$FILE_KPM"
          else
            echo "⚠️ Warning: $FILE_KPM not found."
          fi

          # --- PATCH 2: Hapus MODULE_IMPORT_NS (Fitur Kernel 5.4+) ---
          FILE_KSU="drivers/kernelsu/ksu.c"
          if [ -f "$FILE_KSU" ]; then
             echo "Removing MODULE_IMPORT_NS from $FILE_KSU..."
             # Menghapus baris yang mengandung MODULE_IMPORT_NS
             sed -i '/MODULE_IMPORT_NS/d' "$FILE_KSU"
          else
             echo "⚠️ Warning: $FILE_KSU not found."
          fi
          
          echo "✅ Patching complete."


      # --- BAGIAN UPLOAD KE REPO (Sesuai request sebelumnya) ---
      - name: Commit & Push SukiSU Integration
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          if [[ -n $(git status -s) ]]; then
            git commit -m "chore: Integrate SukiSU Ultra & Fix Compat [skip ci]"
            git push origin main
          else
            echo "No changes detected."
          fi

      # Langkah 5: Unduh Toolchain Clang
      - name: Download Clang Toolchain
        run: git clone https://gitlab.com/PixelOS-Devices/playgroundtc.git --depth=1 clang-toolchain

      # Langkah 6: Atur Environment Build
      - name: Set Up Build Environment
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=DianTk_Modz_sukiSU" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=GitHub-Actions" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "${{ github.workspace }}/clang-toolchain/bin" >> $GITHUB_PATH

      # Langkah 7: Buat .config
      - name: Generate .config
        run: make O=out earth_defconfig

      # Langkah 8: Kompilasi Kernel
      - name: Compile Kernel
        run: |
          make O=out -j$(nproc) KCFLAGS="-Wno-error" LLVM=1 || make O=out -j1 KCFLAGS="-Wno-error" LLVM=1

      # Langkah 9: Upload
      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            out/arch/arm64/boot/Image.gz*
            out/arch/arm64/boot/dts/**/*.dtb
